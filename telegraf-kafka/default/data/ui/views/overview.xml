<dashboard stylesheet="common.css,hover.css,overview.css" script="active_button.js,overview.js" hideEdit="True" isVisible="True">
    <label>Overview</label>

    <search id="main_populate">
        <query>| inputlookup kafka_infra_inventory | search `overview_page_filters`
| stats count by env, label | fields env, label</query>
    </search>

    <fieldset submitButton="false">
        <input type="multiselect" token="env" searchWhenChanged="true">
            <label>Env:</label>
            <!-- Populating Data Model Search -->
            <search base="main_populate">
                <query>dedup env | sort 0 env</query>
            </search>
            <valuePrefix>env="</valuePrefix>
            <valueSuffix>"</valueSuffix>
            <delimiter> OR </delimiter>
            <choice value="*">ANY</choice>
            <initialValue>*</initialValue>
            <fieldForLabel>env</fieldForLabel>
            <fieldForValue>env</fieldForValue>
        </input>
        <input type="multiselect" token="label" searchWhenChanged="true">
            <label>Label:</label>
            <!-- Populating Data Model Search -->
            <search base="main_populate">
                <query>search $env$ | dedup label | sort 0 label</query>
            </search>
            <valuePrefix>label="</valuePrefix>
            <valueSuffix>"</valueSuffix>
            <delimiter> OR </delimiter>
            <choice value="*">ANY</choice>
            <initialValue>*</initialValue>
            <fieldForLabel>label</fieldForLabel>
            <fieldForValue>label</fieldForValue>
        </input>
    </fieldset>

    <!-- Retrieve all metrics available for all components -->
    <search id="all_kafka_components_mcatalog">
        <query>| mcatalog values(server) as server values(jolokia_agent_url) as jolokia_agent_url where `telegraf_kafka_index` metric_name=* $env$ $label$ by metric_name</query>
        <earliest>-5m</earliest>
        <latest>now</latest>
    </search>

    <!-- Detect Zookeeper nodes -->
    <search id="detect_zookeeper" base="all_kafka_components_mcatalog">
        <query>where metric_name="zookeeper.avg_latency" OR metric_name="zookeeper.open_file_descriptor_count"</query>
        <progress>
            <condition match="$job.resultCount$ == 0">
                <unset token="zookeeper_detected"></unset>
            </condition>
            <condition>
                <set token="zookeeper_detected">true</set>
            </condition>
        </progress>
    </search>

    <!-- Detect Kafka brokers -->
    <search id="detect_kafka_broker" base="all_kafka_components_mcatalog">
        <query>where metric_name="kafka_controller.ActiveControllerCount.Value"</query>
        <progress>
            <condition match="$job.resultCount$ == 0">
                <unset token="kafka_broker_detected"></unset>
            </condition>
            <condition>
                <set token="kafka_broker_detected">true</set>
            </condition>
        </progress>
    </search>

    <!-- Detect Kafka Connect -->
    <search id="detect_kafka_connect" base="all_kafka_components_mcatalog">
        <query>where metric_name="kafka_connect.worker.connector-count"</query>
        <progress>
            <condition match="$job.resultCount$ == 0">
                <unset token="kafka_connect_detected"></unset>
            </condition>
            <condition>
                <set token="kafka_connect_detected">true</set>
            </condition>
        </progress>
    </search>

    <!-- Detect Confluent schema-registry -->
    <search id="detect_confluent_schema_registry" base="all_kafka_components_mcatalog">
        <query>where metric_name="kafka_schema-registry.master-slave-role.master-slave-role"</query>
        <progress>
            <condition match="$job.resultCount$ == 0">
                <unset token="schema_registry_detected"></unset>
            </condition>
            <condition>
                <set token="schema_registry_detected">true</set>
            </condition>
        </progress>
    </search>

    <!-- Detect Confluent ksql-server -->
    <search id="detect_confluent_ksql_server" base="all_kafka_components_mcatalog">
        <query>where match(metric_name, "kafka_ksql-server.*(messages-consumed-per-sec|messages-produced-per-sec)")</query>
        <progress>
            <condition match="$job.resultCount$ == 0">
                <unset token="ksql_server_detected"></unset>
            </condition>
            <condition>
                <set token="ksql_server_detected">true</set>
            </condition>
        </progress>
    </search>

    <!-- Detect Confluent kafka-rest -->
    <search id="detect_confluent_kafka_rest" base="all_kafka_components_mcatalog">
        <query>where metric_name="kafka_kafka-rest.jetty-metrics.connections-active"</query>
        <progress>
            <condition match="$job.resultCount$ == 0">
                <unset token="kafka_rest_detected"></unset>
            </condition>
            <condition>
                <set token="kafka_rest_detected">true</set>
            </condition>
        </progress>
    </search>

    <!-- Detect Burrow -->
    <search id="detect_burrow" base="all_kafka_components_mcatalog">
        <query>where metric_name="burrow_group.status_code"</query>
        <progress>
            <condition match="$job.resultCount$ == 0">
                <unset token="burrow_detected"></unset>
            </condition>
            <condition>
                <set token="burrow_detected">true</set>
            </condition>
        </progress>
    </search>

    <!-- base search for Zookeeper -->

    <search id="server_activity_summary" depends="$zookeeper_detected$">
        <query>| mstats avg(_value) as value where `telegraf_kafka_index` metric_name="zookeeper.avg_latency" OR metric_name="zookeeper.outstanding_requests" OR metric_name="zookeeper.pending_syncs" $env$ $label$ by metric_name span=1s
            | eval {metric_name}=value
            | stats first(zookeeper.*) as "*" by _time
            | stats avg(*) as "*"
            | eval pending_syncs=if(isnull(pending_syncs), 0, pending_syncs)</query>
        <earliest>-90s</earliest>
        <latest>now</latest>
        <refresh>90s</refresh>
        <refreshType>delay</refreshType>
    </search>

    <!-- base search for Kafka brokers -->

    <search id="broker_activity_summary" depends="$kafka_broker_detected$">
        <query>| mstats avg(_value) as value where `telegraf_kafka_index` metric_name="kafka_topics.MessagesInPerSec.OneMinuteRate" OR metric_name="kafka_topics.BytesInPerSec.OneMinuteRate" OR metric_name="kafka_topics.BytesOutPerSec.OneMinuteRate" $env$ $label$ by metric_name
            | eval {metric_name}=value
            | stats first(kafka_topics.*.OneMinuteRate) as "*"
            | eval KBytesInPerSec=round(BytesInPerSec/1024, 2), KBytesOutPerSec=round(BytesOutPerSec/1024, 2), MessagesInPerSec=round(MessagesInPerSec, 2)
            | fields KBytesInPerSec, KBytesOutPerSec, MessagesInPerSec</query>
        <earliest>-90s</earliest>
        <latest>now</latest>
        <refresh>90s</refresh>
        <refreshType>delay</refreshType>
    </search>

    <!-- base search for Kafka Connect -->

    <search id="connect_state_summary" depends="$kafka_connect_detected$">
        <query>| mstats latest(_value) as value WHERE `telegraf_kafka_index` metric_name="kafka_connect.worker.task-startup-failure-total" OR metric_name="kafka_connect.worker.connector-startup-failure-total" OR metric_name="kafka_connect.worker.time-since-last-rebalance-ms" OR metric_name="kafka_connect.worker.task-count" $env$ $label$ by metric_name, env, label, jolokia_agent_url
            | eval {metric_name}=value
            | stats first(kafka_connect.*) as "*" by env, label, jolokia_agent_url
            | stats min(worker.time-since-last-rebalance-ms) as worker.time-since-last-rebalance-ms, sum(*) as "*"
            | eval duration=tostring(round('worker.time-since-last-rebalance-ms'/1000, 0), "duration")
            | fields worker.connector-startup-failure-total, worker.task-startup-failure-total, worker.task-count, duration</query>
        <earliest>-90s</earliest>
        <latest>now</latest>
        <refresh>90s</refresh>
        <refreshType>delay</refreshType>
    </search>

    <search id="connect_tasks_summary" depends="$kafka_connect_detected$">
        <query>| mstats latest(_value) as value WHERE `telegraf_kafka_index` metric_name="kafka_connect.connector-task.status" OR metric_name="kafka_connect.connector-task.running-ratio" OR metric_name="kafka_connect.error-task.total-errors-logged" OR metric_name="kafka_connect.error-task.total-retries" connector="*" $env$ $label$ by metric_name, env, label, task, connector
            | eval {metric_name}=value
            | stats min(kafka_connect.connector-task.status) as connector-task.status, first(kafka_connect.*) as "*" by env, label, connector
            | eval connector-task.running-ratio=round('connector-task.running-ratio'*100, 2) | fields env, label, connector connector-task.status | rename connector-task.status as integer_status
            | eval status=case(integer_status=0, "paused", integer_status=1, "running", integer_status=2, "unassigned", integer_status=3, "failed", integer_status=4, "destroyed")
            | join env, label, connector [ | inputlookup kafka_connect_tasks_monitoring ] | where monitoring_state="enabled"</query>
        <earliest>-90s</earliest>
        <latest>now</latest>
        <refresh>90s</refresh>
        <refreshType>delay</refreshType>
    </search>

    <!-- base search for Confluent schema registry -->

    <search id="schema_registry_summary" depends="$schema_registry_detected$">
        <query>| mstats avg(_value) as value WHERE `telegraf_kafka_index` metric_name="kafka_schema-registry.jetty-metrics.connections-active" OR  metric_name="kafka_schema-registry.jetty-metrics.connections-opened-rate" OR metric_name="kafka_schema-registry.jetty-metrics.connections-closed-rate" $env$ $label$ by metric_name
            | eval {metric_name}=value
            | stats first(kafka_schema-registry.*) as "*"</query>
        <earliest>-90s</earliest>
        <latest>now</latest>
        <refresh>90s</refresh>
        <refreshType>delay</refreshType>
    </search>

    <search id="schema_registry_summary_jersey" depends="$schema_registry_detected$">
        <query>| mstats avg(_value) as value WHERE `telegraf_kafka_index` metric_name="kafka_schema-registry.jersey-metrics.request-error-rate" $env$ $label$ by metric_name
            | eval {metric_name}=value
            | stats first(kafka_schema-registry.*) as "*"</query>
        <earliest>-90s</earliest>
        <latest>now</latest>
        <refresh>90s</refresh>
        <refreshType>delay</refreshType>
    </search>

    <!-- base search for Confluence ksql-server -->

    <search id="ksql_server_queries_activity_summary" depends="$ksql_server_detected$">
        <query>| mstats latest(_value) as value WHERE `telegraf_kafka_index` metric_name="kafka_ksql-server.*num-persistent-queries" OR metric_name="kafka_ksql-server.*num-active-queries" OR metric_name="kafka_ksql-server.*num-idle-queries" $env$ $label$ by metric_name
            | rex field=metric_name "(?&lt;metric_name&gt;num-persistent-queries|num-active-queries|num-idle-queries)"
            | eval {metric_name}=value
            | stats first(*) as "*"
            | fields num-active-queries, num-persistent-queries, num-idle-queries</query>
        <earliest>-90s</earliest>
        <latest>now</latest>
        <refresh>30s</refresh>
        <refreshType>delay</refreshType>
    </search>

    <search id="ksql_server_stats_activity_summary" depends="$ksql_server_detected$">
        <query>| mstats avg(_value) as value WHERE `telegraf_kafka_index` metric_name=kafka_ksql-server.*messages-consumed-per-sec OR metric_name=kafka_ksql-server.*messages-produced-per-sec OR metric_name="kafka_ksql-server.*error-rate" $env$ $label$ by metric_name
            | rex field=metric_name "(?&lt;metric_name&gt;messages-consumed-per-sec|messages-produced-per-sec|error-rate)"
            | eval {metric_name}=value
            | stats first(*) as "*"
            | eval messages-consumed-per-sec=round('messages-consumed-per-sec', 2), messages-produced-per-sec=round('messages-produced-per-sec', 2)
            | fields messages-produced-per-sec, messages-consumed-per-sec, error-rate</query>
        <earliest>-90s</earliest>
        <latest>now</latest>
        <refresh>30s</refresh>
        <refreshType>delay</refreshType>
    </search>

    <!-- base search for Confluent kafka-rest -->

    <search id="kafka_rest_summary" depends="$kafka_rest_detected$">
        <query>| mstats avg(_value) as value WHERE `telegraf_kafka_index` metric_name="kafka_kafka-rest.jetty-metrics.connections-active" OR  metric_name="kafka_kafka-rest.jetty-metrics.connections-opened-rate" OR metric_name="kafka_kafka-rest.jetty-metrics.connections-closed-rate" $env$ $label$ by metric_name
            | eval {metric_name}=value
            | stats first(kafka_kafka-rest.*) as "*"</query>
        <earliest>-90s</earliest>
        <latest>now</latest>
        <refresh>90s</refresh>
        <refreshType>delay</refreshType>
    </search>

    <search id="kafka_rest_summary_jersey" depends="$kafka_rest_detected$">
        <query>| mstats avg(_value) as value WHERE `telegraf_kafka_index` metric_name="kafka_kafka-rest.jersey-metrics.request-error-rate" $env$ $label$ by metric_name
            | eval {metric_name}=value
            | stats first(kafka_kafka-rest.*) as "*"</query>
        <earliest>-90s</earliest>
        <latest>now</latest>
        <refresh>90s</refresh>
        <refreshType>delay</refreshType>
    </search>

    <!-- base search for Burrow -->

    <search id="burrow" depends="$burrow_detected$">
        <query>| mstats latest(_value) as value where metric_name="burrow_group.lag" OR metric_name="burrow_group.status_code" `telegraf_kafka_index` group!="" $env$ $label$ by env, label, cluster, group, metric_name span=10s
| eval {metric_name}=value
| stats first(burrow_group.*) as "*" by _time, env, label, cluster, group
| stats max(_time) as lastTime, avg(lag) as avg_lag, max(lag) as max_lag, latest(lag) as current, latest(status_code) as status_code by env, label, cluster, group
| lookup burrow_status status_code OUTPUT status, description
| rangemap field=status_code low=1-1 elevated=2-2 default=severe
| eval avg_lag=round(avg_lag, 3), delta_lastTime=now()-lastTime, lastTime=strftime(lastTime, "%H:%M:%S")
| fields env, label, cluster, group, avg_lag, max_lag, current, status, range, lastTime</query>
        <earliest>-90s</earliest>
        <latest>now</latest>
        <refresh>90s</refresh>
        <refreshType>delay</refreshType>
    </search>

    <!--

    ZOOKEEPER

    -->

    <row>
        <panel>
            <html>
                <div class="dashseparator">
                    <div class="box">
                      <img src="../../static/app/telegraf-kafka/icons/zookeeper.png"/>
                      <span style="font-size: 22px; font-weight: bold; color: #999999; margin-top: 5px;">ZOOKEEPER</span>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row depends="$zookeeper_detected$">
        <panel>
            <single>
                <search depends="$zookeeper_detected$">
                    <query>| savedsearch telegraf-kafka-zookeeper-servers | search $env$ $label$ | stats count</query>
                    <earliest>-15m</earliest>
                    <latest>now</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">all</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">ZOOKEEPER SERVER</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="server_activity_summary">
                    <query>fields avg_latency</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
                <option name="rangeValues">[10]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">AVERAGE LATENCY</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="server_activity_summary">
                    <query>fields outstanding_requests</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
                <option name="rangeValues">[10]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">OUTSTANDING REQUESTS</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="server_activity_summary">
                    <query>fields pending_syncs</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
                <option name="rangeValues">[10]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">PENDING SYNCS</option>
                <option name="useColors">1</option>
            </single>
        </panel>
    </row>

    <row depends="$zookeeper_detected$">
        <panel>
            <html>
                <div class="mainbutton_container_nomargin">
                    <div class="mainbutton_highmargin">
                        <a class="button2_lowpadding glow" href="telegraf-kafka-zookeeper?form.env=$form.env$&amp;form.label=$form.label$">  OPEN ENTITY DASHBOARD VIEW  </a>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row rejects="$zookeeper_detected$">
        <panel>
            <html>
                <div style="text-align: left; font-style: italic;">
                    <h2 style="color: #779ecb;">NO ACTIVE ZOOKEEPER NODES DETECTED</h2>
                </div>
            </html>
        </panel>
    </row>

    <!--

    KAFKA BROKERS

    -->

    <row>
        <panel>
            <html>
                <div class="dashseparator">
                    <div class="box">
                      <img src="../../static/app/telegraf-kafka/icons/kafka-logo-no-text.png"/>
                      <span style="font-size: 22px; font-weight: bold; color: #999999; margin-top: 5px;">KAFKA BROKERS</span>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row depends="$kafka_broker_detected$">
        <panel>
            <single>
                <search depends="$kafka_broker_detected$">
                    <query>| savedsearch telegraf-kafka-kafka-brokers | search $env$ $label$ | stats count</query>
                    <earliest>-15m</earliest>
                    <latest>now</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">all</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">KAFKA BROKERS</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search depends="$kafka_broker_detected$">
                    <query>| mstats latest(_value) as value where `telegraf_kafka_index` metric_name="kafka_controller.OfflinePartitionsCount.Value" $env$ $label$ by jolokia_agent_url
                        | stats sum(value) as value</query>
                    <earliest>-90s</earliest>
                    <latest>now</latest>
                    <refresh>90s</refresh>
                    <refreshType>delay</refreshType>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">OFFLINE PARTITIONS</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search depends="$kafka_broker_detected$">
                    <query>| mstats latest(_value) as value where `telegraf_kafka_index` metric_name="kafka_replica_manager.UnderReplicatedPartitions.Value" $env$ $label$ by jolokia_agent_url
                        | stats sum(value) as value</query>
                    <earliest>-90s</earliest>
                    <latest>now</latest>
                    <refresh>90s</refresh>
                    <refreshType>delay</refreshType>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">UNDER-REPLICATED PARTITIONS</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="broker_activity_summary">
                    <query>fields MessagesInPerSec</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">REALTIME AVG MESSAGES/IN SEC</option>
                <option name="unit">msg/sec</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="broker_activity_summary">
                    <query>fields KBytesInPerSec</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">REALTIME AVG TRAFFIC IN</option>
                <option name="unit">Kbps in</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="broker_activity_summary">
                    <query>fields KBytesInPerSec</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">REALTIME AVG TRAFFIC OUT</option>
                <option name="unit">Kbps out</option>
                <option name="useColors">1</option>
            </single>
        </panel>
    </row>

    <row depends="$kafka_broker_detected$">
        <panel>
            <html>
                <div class="mainbutton_highmargin">
                    <a class="button2_lowpadding glow" href="telegraf-kafka-kafka-brokers?form.env=$form.env$&amp;form.label=$form.label$">  OPEN ENTITY DASHBOARD VIEW  </a>
                </div>
            </html>
        </panel>
        <panel>
            <html>
                <div class="custom-sub-nav" style="text-align: center;">
                    <div class="mainbutton_highmargin">
                        <button class="button2_lowpadding glow" data-token-name="show_brokers_overview" data-alt-label="HIDE OVERVIEW" data-token-value="fields *">SHOW BROKERS OVERVIEW</button>
                    </div>
                </div>
            </html>
        </panel>
        <panel>
            <html>
                <div class="mainbutton_highmargin">
                    <a class="button2_lowpadding glow" href="telegraf-kafka-kafka-topics?form.env=$form.env$&amp;form.label=$form.label$">  OPEN TOPIC DASHBOARD VIEW  </a>
                </div>
            </html>
        </panel>
        <panel>
            <html>
                <div class="custom-sub-nav" style="text-align: center;">
                    <div class="mainbutton_highmargin">
                        <button class="button2_lowpadding glow" data-token-name="show_topics_overview" data-alt-label="HIDE OVERVIEW" data-token-value="fields *">SHOW TOPICS OVERVIEW</button>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <search depends="$show_brokers_overview$" id="brokers_main_populate">
        <query>| savedsearch telegraf-kafka-kafka-brokers | search $env$ $label$</query>
        <earliest>$brokers_time.earliest$</earliest>
        <latest>$brokers_time.latest$</latest>
    </search>

    <row depends="$show_brokers_overview$">
        <panel>
            <title>Kafka brokers overview</title>
            <input type="time" token="brokers_time" searchWhenChanged="true">
                <label></label>
                <default>
                    <earliestTime>-4h</earliestTime>
                    <latestTime>now</latestTime>
                </default>
            </input>
            <input type="multiselect" token="env" searchWhenChanged="true">
                <label>Env:</label>
                <!-- Populating Data Model Search -->
                <search base="main_populate">
                    <query>dedup env | sort 0 env</query>
                </search>
                <valuePrefix>env="</valuePrefix>
                <valueSuffix>"</valueSuffix>
                <delimiter> OR </delimiter>
                <choice value="*">ANY</choice>
                <initialValue>*</initialValue>
                <fieldForLabel>env</fieldForLabel>
                <fieldForValue>env</fieldForValue>
            </input>
            <input type="multiselect" token="label" searchWhenChanged="true">
                <label>Label:</label>
                <!-- Populating Data Model Search -->
                <search base="main_populate">
                    <query>search $env$ | dedup label | sort 0 label</query>
                </search>
                <valuePrefix>label="</valuePrefix>
                <valueSuffix>"</valueSuffix>
                <delimiter> OR </delimiter>
                <choice value="*">ANY</choice>
                <initialValue>*</initialValue>
                <fieldForLabel>label</fieldForLabel>
                <fieldForValue>label</fieldForValue>
            </input>
            <input type="multiselect" token="brokers_jolokia_agent_url" searchWhenChanged="true">
                <label>Kafka broker(s):</label>
                <!-- Populating Data Model Search -->
                <search base="brokers_main_populate">
                    <query>search $env$ $label$ | dedup jolokia_agent_url | sort jolokia_agent_url</query>
                </search>
                <valuePrefix>jolokia_agent_url="</valuePrefix>
                <valueSuffix>"</valueSuffix>
                <delimiter> OR </delimiter>
                <choice value="*">ANY</choice>
                <initialValue>*</initialValue>
                <fieldForLabel>jolokia_agent_url</fieldForLabel>
                <fieldForValue>jolokia_agent_url</fieldForValue>
            </input>
        </panel>
    </row>

    <row depends="$show_brokers_overview$">
        <panel>
            <title>All topics messages per sec</title>
            <chart>
                <search depends="$show_brokers_overview$">
                    <query>| mstats avg(_value) prestats=true where `telegraf_kafka_index` metric_name="kafka_topics.MessagesInPerSec.OneMinuteRate" $env$ $label$ $brokers_jolokia_agent_url$ span=10s by jolokia_agent_url
| timechart limit=20 useother=f `telegraf_kafka_span` avg(_value) as MessagesInPerSec by jolokia_agent_url</query>
                    <earliest>$brokers_time.earliest$</earliest>
                    <latest>$brokers_time.latest$</latest>
                    <sampleRatio>1</sampleRatio>
                </search>
                <option name="charting.chart">line</option>
                <option name="charting.axisTitleX.visibility">collapsed</option>
                <option name="charting.axisTitleY.visibility">collapsed</option>
                <option name="charting.chart.nullValueMode">gaps</option>
                <option name="charting.chart.showDataLabels">none</option>
                <option name="charting.legend.placement">top</option>
                <option name="charting.drilldown">all</option>
            </chart>
        </panel>
    </row>
    <row depends="$show_brokers_overview$">
        <panel>
            <title>All topics KBytesInPerSec</title>
            <chart>
                <search depends="$show_brokers_overview$">
                    <query>| mstats avg(_value) as value where `telegraf_kafka_index` metric_name="kafka_topics.BytesInPerSec.OneMinuteRate" $env$ $label$ $brokers_jolokia_agent_url$ span=10s by jolokia_agent_url
| eval value=value/1024
| timechart limit=20 useother=f `telegraf_kafka_span` avg(value) as KBytesInPerSec by jolokia_agent_url</query>
                    <earliest>$brokers_time.earliest$</earliest>
                    <latest>$brokers_time.latest$</latest>
                    <sampleRatio>1</sampleRatio>
                </search>
                <option name="charting.chart">line</option>
                <option name="charting.axisTitleX.visibility">collapsed</option>
                <option name="charting.axisTitleY.visibility">collapsed</option>
                <option name="charting.chart.nullValueMode">gaps</option>
                <option name="charting.chart.showDataLabels">none</option>
                <option name="charting.legend.placement">top</option>
                <option name="charting.drilldown">all</option>
            </chart>
        </panel>
        <panel>
            <title>All topics KBytesOutPerSec</title>
            <chart>
                <search depends="$show_brokers_overview$">
                    <query>| mstats avg(_value) as value where `telegraf_kafka_index` metric_name="kafka_topics.BytesOutPerSec.OneMinuteRate" $env$ $label$ $brokers_jolokia_agent_url$ span=10s by jolokia_agent_url
| eval value=value/1024
| timechart limit=20 useother=f `telegraf_kafka_span` avg(value) as KBytesOutPerSec by jolokia_agent_url</query>
                    <earliest>$brokers_time.earliest$</earliest>
                    <latest>$brokers_time.latest$</latest>
                    <sampleRatio>1</sampleRatio>
                </search>
                <option name="charting.chart">line</option>
                <option name="charting.axisTitleX.visibility">collapsed</option>
                <option name="charting.axisTitleY.visibility">collapsed</option>
                <option name="charting.chart.nullValueMode">gaps</option>
                <option name="charting.chart.showDataLabels">none</option>
                <option name="charting.legend.placement">top</option>
                <option name="charting.drilldown">all</option>
            </chart>
        </panel>
    </row>

    <search depends="$show_topics_overview$" id="main_populate_topics">
        <query>| savedsearch telegraf-kafka-kafka-topics | search $env$ $label$</query>
        <earliest>$topics_time.earliest$</earliest>
        <latest>$topics_time.latest$</latest>
    </search>

    <row depends="$show_topics_overview$">
        <panel>
            <title>Kafka topics overview</title>
            <input type="time" token="topics_time" searchWhenChanged="true">
                <label></label>
                <default>
                    <earliestTime>-4h</earliestTime>
                    <latestTime>now</latestTime>
                </default>
            </input>
            <input type="multiselect" token="env" searchWhenChanged="true">
                <label>Env:</label>
                <!-- Populating Data Model Search -->
                <search base="main_populate">
                    <query>dedup env | sort 0 env</query>
                </search>
                <valuePrefix>env="</valuePrefix>
                <valueSuffix>"</valueSuffix>
                <delimiter> OR </delimiter>
                <choice value="*">ANY</choice>
                <initialValue>*</initialValue>
                <fieldForLabel>env</fieldForLabel>
                <fieldForValue>env</fieldForValue>
            </input>
            <input type="multiselect" token="label" searchWhenChanged="true">
                <label>Label:</label>
                <!-- Populating Data Model Search -->
                <search base="main_populate">
                    <query>search $env$ | dedup label | sort 0 label</query>
                </search>
                <valuePrefix>label="</valuePrefix>
                <valueSuffix>"</valueSuffix>
                <delimiter> OR </delimiter>
                <choice value="*">ANY</choice>
                <initialValue>*</initialValue>
                <fieldForLabel>label</fieldForLabel>
                <fieldForValue>label</fieldForValue>
            </input>
            <input type="multiselect" token="topics_topic" searchWhenChanged="true">
                <label>Kafka topic(s):</label>
                <!-- Populating Data Model Search -->
                <search base="main_populate_topics">
                    <query>search $env$ $label$ | dedup kafka_topic | sort 0 kafka_topic</query>
                </search>
                <valuePrefix>topic="</valuePrefix>
                <valueSuffix>"</valueSuffix>
                <delimiter> OR </delimiter>
                <choice value="*">ANY</choice>
                <initialValue>*</initialValue>
                <fieldForLabel>kafka_topic</fieldForLabel>
                <fieldForValue>kafka_topic</fieldForValue>
            </input>
        </panel>
    </row>

    <row depends="$show_topics_overview$">
        <panel>
            <title>Messages/sec</title>
            <chart>
                <search depends="$show_topics_overview$">
                    <query>| mstats avg(_value) prestats=true where `telegraf_kafka_index` metric_name="kafka_topic.MessagesInPerSec.OneMinuteRate" $env$ $label$ $topics_topic$ span=10s by topic
| eval value=round(value, 3)
| timechart `telegraf_kafka_span` avg(_value) as "Avg" limit=20 useother=false by topic</query>
                    <earliest>$topics_time.earliest$</earliest>
                    <latest>$topics_time.latest$</latest>
                </search>
                <option name="charting.chart">line</option>
                <option name="charting.axisTitleX.visibility">collapsed</option>
                <option name="charting.axisTitleY.visibility">collapsed</option>
                <option name="charting.chart.nullValueMode">gaps</option>
                <option name="charting.chart.showDataLabels">none</option>
                <option name="charting.legend.placement">top</option>
                <option name="charting.drilldown">all</option>
            </chart>
        </panel>
    </row>

    <row depends="$show_topics_overview$">
        <panel>
            <title>Traffic Kbps/In</title>
            <chart>
                <search depends="$show_topics_overview$">
                    <query>| mstats avg(_value) as value where `telegraf_kafka_index` metric_name="kafka_topic.BytesInPerSec.OneMinuteRate" $env$ $label$ $topics_topic$ span=10s by topic
| eval value=round(value/1024, 3)
| timechart `telegraf_kafka_span` avg(value) as "Avg" useother=false by topic</query>
                    <earliest>$topics_time.earliest$</earliest>
                    <latest>$topics_time.latest$</latest>
                </search>
                <option name="charting.chart">line</option>
                <option name="charting.axisTitleX.visibility">collapsed</option>
                <option name="charting.axisTitleY.visibility">collapsed</option>
                <option name="charting.chart.nullValueMode">gaps</option>
                <option name="charting.chart.showDataLabels">none</option>
                <option name="charting.legend.placement">top</option>
                <option name="charting.drilldown">all</option>
            </chart>
        </panel>
        <panel>
            <title>Traffic Kbps/Out</title>
            <chart>
                <search depends="$show_topics_overview$">
                    <query>| mstats avg(_value) as value where `telegraf_kafka_index` metric_name="kafka_topic.BytesOutPerSec.OneMinuteRate" $env$ $label$ $topics_topic$ span=10s by topic
| eval value=round(value/1024, 3)
| timechart `telegraf_kafka_span` avg(value) as "Avg" useother=false by topic</query>
                    <earliest>$topics_time.earliest$</earliest>
                    <latest>$topics_time.latest$</latest>
                </search>
                <option name="charting.chart">line</option>
                <option name="charting.axisTitleX.visibility">collapsed</option>
                <option name="charting.axisTitleY.visibility">collapsed</option>
                <option name="charting.chart.nullValueMode">gaps</option>
                <option name="charting.chart.showDataLabels">none</option>
                <option name="charting.legend.placement">top</option>
                <option name="charting.drilldown">all</option>
            </chart>
        </panel>
    </row>

    <row rejects="$kafka_broker_detected$">
        <panel>
            <html>
                <div style="text-align: left; font-style: italic;">
                    <h2 style="color: #779ecb;">NO ACTIVE KAFKA BROKERS DETECTED</h2>
                </div>
            </html>
        </panel>
    </row>

    <!--

    KAFKA CONNECT WORKERS

    -->

    <row>
        <panel>
            <html>
                <div class="dashseparator">
                    <div class="box">
                      <img src="../../static/app/telegraf-kafka/icons/kafka-logo-no-text.png"/>
                      <span style="font-size: 22px; font-weight: bold; color: #999999; margin-top: 5px;">KAFKA CONNECT WORKERS</span>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row depends="$kafka_connect_detected$">
        <panel>
            <single>
                <search depends="$kafka_connect_detected$">
                    <query>| savedsearch telegraf-kafka-kafka-connect-workers | search $env$ $label$ | stats count</query>
                    <earliest>-15m</earliest>
                    <latest>now</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">all</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">KAFKA CONNECT WORKERS</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="connect_state_summary">
                    <query>fields worker.connector-startup-failure-total</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">FAILED WORKER STARTUP</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="connect_state_summary">
                    <query>fields worker.task-startup-failure-total</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">FAILED TASKS STARTUP</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="connect_state_summary">
                    <query>fields duration</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">DURATION SINCE LAST REBALANCE (MIN FOR ALL WORKERS)</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="connect_state_summary">
                    <query>fields worker.task-count</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">all</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">WORKER TASKS COUNT (TOTAL TASKS FOR ALL WORKERS)</option>
                <option name="useColors">1</option>
                <drilldown>
                    <link target="_blank">search?q=| mstats latest(_value) as value WHERE `telegraf_kafka_index` metric_name="kafka_connect.worker.task-startup-failure-total" OR metric_name="kafka_connect.worker.connector-startup-failure-total" OR metric_name="kafka_connect.worker.time-since-last-rebalance-ms" OR metric_name="kafka_connect.worker.task-count" $env$ $label$ by metric_name, env, label, jolokia_agent_url
| eval {metric_name}=value
| stats first(kafka_connect.*) as "*" by env, label, jolokia_agent_url
                        | eval duration=tostring(round('worker.time-since-last-rebalance-ms'/1000, 0), "duration")</link>
                </drilldown>
            </single>
        </panel>
    </row>

    <row depends="$kafka_connect_detected$">
        <panel>
            <html>
                <div class="mainbutton_container_nomargin">
                    <div class="mainbutton_highmargin">
                        <a class="button2_lowpadding glow" href="telegraf-kafka-kafka-connect?form.env=$form.env$&amp;form.label=$form.label$">  OPEN ENTITY DASHBOARD VIEW  </a>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row depends="$kafka_connect_detected$">
        <panel>
            <html>
                <div class="dashseparator">
                    <h1>KAFKA CONNECT SOURCE TASKS</h1>
                </div>
            </html>
        </panel>
        <panel>
            <html>
                <div class="dashseparator">
                    <h1>KAFKA CONNECT SINK TASKS</h1>
                </div>
            </html>
        </panel>
    </row>

    <row depends="$kafka_connect_detected$">
        <panel>
            <single>
                <search base="connect_tasks_summary">
                    <query>where role="kafka_source_task" | stats count</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">all</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">SOURCE CONNECTORS (ACTIVE AND MONITORED)</option>
                <option name="useColors">1</option>
                <drilldown>
                  <link target="_blank">search?q=| mstats latest(_value) as value WHERE index="telegraf_kafka" metric_name="kafka_connect.connector-task.status" OR metric_name="kafka_connect.connector-task.running-ratio" OR metric_name="kafka_connect.error-task.total-errors-logged" OR metric_name="kafka_connect.error-task.total-retries" connector="*" $env$ $label$ by metric_name, env, label, task, connector
| eval {metric_name}=value
| stats min(kafka_connect.connector-task.status) as connector-task.status, first(kafka_connect.*) as "*" by env, label, connector, task
| eval connector-task.running-ratio=round('connector-task.running-ratio'*100, 2)
| fields env, label, connector, task, connector-task.status
| rename connector-task.status as integer_status
| eval status=case(integer_status=0, "paused", integer_status=1, "running", integer_status=2, "unassigned", integer_status=3, "failed", integer_status=4, "destroyed")
| join env, label, connector [ | inputlookup kafka_connect_tasks_monitoring ]
| stats first(*) as "*", values(task) as task, list(status) as status by env, label, connector
| fields env, label, connector, role, task, status, monitoring_state
| where monitoring_state="enabled" | where role="kafka_source_task"&amp;earliest=-90s&amp;latest=now</link>
                </drilldown>
            </single>
        </panel>
        <panel>
            <single>
                <search base="connect_tasks_summary">
                    <query>where role="kafka_source_task"
| fillnull value=5 integer_status
| rangemap field=integer_status low=1-1 high=2-5 default=severe
| fields status, range, integer_status
| sort - limit=0 integer_status | append [ makeresults ] | fillnull value="unknown" status | fillnull value="elevated" range | fields - _time</query>
                </search>
                <option name="colorBy">value</option>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0</option>
                <option name="useColors">0</option>
                <option name="underLabel">AGGREGATED STATE</option>
                <option name="drilldown">all</option>
                <drilldown>
                  <link target="_blank">search?q=| mstats latest(_value) as value WHERE `telegraf_kafka_index` metric_name="kafka_connect.connector-task.status" OR metric_name="kafka_connect.connector-task.running-ratio" OR metric_name="kafka_connect.error-task.total-errors-logged" OR metric_name="kafka_connect.error-task.total-retries" connector="*" $env$ $label$ by metric_name, task, connector
| eval {metric_name}=value
| stats min(kafka_connect.connector-task.status) as connector-task.status, first(kafka_connect.*) as "*" by connector
| eval connector-task.running-ratio=round('connector-task.running-ratio'*100, 2) | fields connector connector-task.status | rename connector-task.status as integer_status
| eval status=case(integer_status=0, "paused", integer_status=1, "running", integer_status=2, "unassigned", integer_status=3, "failed", integer_status=4, "destroyed")
| join connector [ | inputlookup kafka_connect_tasks_monitoring ] | where monitoring_state="enabled" | where role="kafka_source_task" | fillnull value="severe" status&amp;earliest=-90s&amp;latest=now</link>
                </drilldown>
            </single>
        </panel>
        <panel>
            <single>
                <search base="connect_tasks_summary">
                    <query>where role="kafka_sink_task" | stats count</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">all</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">SINK CONNECTORS (ACTIVE AND MONITORED)</option>
                <option name="useColors">1</option>
                <drilldown>
                  <link target="_blank">search?q=| mstats latest(_value) as value WHERE index="telegraf_kafka" metric_name="kafka_connect.connector-task.status" OR metric_name="kafka_connect.connector-task.running-ratio" OR metric_name="kafka_connect.error-task.total-errors-logged" OR metric_name="kafka_connect.error-task.total-retries" connector="*" $env$ $label$ by metric_name, env, label, task, connector
| eval {metric_name}=value
| stats min(kafka_connect.connector-task.status) as connector-task.status, first(kafka_connect.*) as "*" by env, label, connector, task
| eval connector-task.running-ratio=round('connector-task.running-ratio'*100, 2)
| fields env, label, connector, task, connector-task.status
| rename connector-task.status as integer_status
| eval status=case(integer_status=0, "paused", integer_status=1, "running", integer_status=2, "unassigned", integer_status=3, "failed", integer_status=4, "destroyed")
| join env, label, connector [ | inputlookup kafka_connect_tasks_monitoring ]
| stats first(*) as "*", values(task) as task, list(status) as status by env, label, connector
| fields env, label, connector, role, task, status, monitoring_state
| where monitoring_state="enabled" | where role="kafka_sink_task"&amp;earliest=-90s&amp;latest=now</link>
                </drilldown>
            </single>
        </panel>
        <panel>
            <single>
                <search base="connect_tasks_summary">
                    <query>where role="kafka_sink_task"
| fillnull value=5 integer_status
| rangemap field=integer_status low=1-1 high=2-5 default=severe
| fields status, range, integer_status
| sort - limit=0 integer_status | append [ makeresults ] | fillnull value="unknown" status | fillnull value="elevated" range | fields - _time</query>
                </search>
                <option name="colorBy">value</option>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0</option>
                <option name="useColors">0</option>
                <option name="underLabel">AGGREGATED STATE</option>
                <option name="drilldown">all</option>
                <drilldown>
                  <link target="_blank">search?q=| mstats latest(_value) as value WHERE `telegraf_kafka_index` metric_name="kafka_connect.connector-task.status" OR metric_name="kafka_connect.connector-task.running-ratio" OR metric_name="kafka_connect.error-task.total-errors-logged" OR metric_name="kafka_connect.error-task.total-retries" connector="*" $env$ $label$ by metric_name, task, connector
| eval {metric_name}=value
| stats min(kafka_connect.connector-task.status) as connector-task.status, first(kafka_connect.*) as "*" by connector
| eval connector-task.running-ratio=round('connector-task.running-ratio'*100, 2) | fields connector connector-task.status | rename connector-task.status as integer_status
| eval status=case(integer_status=0, "paused", integer_status=1, "running", integer_status=2, "unassigned", integer_status=3, "failed", integer_status=4, "destroyed")
| join connector [ | inputlookup kafka_connect_tasks_monitoring ] | where monitoring_state="enabled" | where role="kafka_sink_task" | fillnull value="severe" status&amp;earliest=-90s&amp;latest=now</link>
                </drilldown>
            </single>
        </panel>
    </row>

    <row depends="$kafka_connect_detected$">
        <panel>
            <html>
                <div class="mainbutton_container_nomargin">
                    <div class="mainbutton_highmargin">
                        <a class="button2_lowpadding glow" href="telegraf-kafka-kafka-connect-source-task?form.env=$form.env$&amp;form.label=$form.label$">  SOURCE TASK DASHBOARD VIEW  </a>
                    </div>
                </div>
            </html>
        </panel>
        <panel>
            <html>
                <div class="custom-sub-nav" style="text-align: center;">
                    <div class="mainbutton_highmargin">
                        <button class="button2_lowpadding glow" data-token-name="show_source_tasks" data-alt-label="HIDE TASKS STATUS" data-token-value="fields *">SHOW TASKS STATUS</button>
                    </div>
                </div>
            </html>
        </panel>
        <panel>
            <html>
                <div class="mainbutton_container_nomargin">
                    <div class="mainbutton_highmargin">
                        <a class="button2_lowpadding glow" href="telegraf-kafka-kafka-connect-sink-task?form.env=$form.env$&amp;form.label=$form.label$">  SINK TASK DASHBOARD VIEW  </a>
                    </div>
                </div>
            </html>
        </panel>
        <panel>
            <html>
                <div class="custom-sub-nav" style="text-align: center;">
                    <div class="mainbutton_highmargin">
                        <button class="button2_lowpadding glow" data-token-name="show_sink_tasks" data-alt-label="HIDE TASKS STATUS" data-token-value="fields *">SHOW TASKS STATUS</button>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row depends="$show_source_tasks$">
        <panel>
            <table>
            <title>Kafka Connect source connector tasks status</title>
                <search depends="$show_source_tasks$">
                    <query>| savedsearch "Kafka monitoring - tasks status report" | search $env$ $label$ | where role="kafka_source_task"</query>
                    <earliest>-15m</earliest>
                    <latest>now</latest>
                </search>
            </table>
        </panel>
    </row>

    <row depends="$show_sink_tasks$">
        <panel>
            <table>
            <title>Kafka Connect sink connector tasks status</title>
                <search depends="$show_sink_tasks$">
                    <query>| savedsearch "Kafka monitoring - tasks status report" | search $env$ $label$ | where role="kafka_sink_task"</query>
                    <earliest>-15m</earliest>
                    <latest>now</latest>
                </search>
            </table>
        </panel>
    </row>

    <row rejects="$kafka_connect_detected$">
        <panel>
            <html>
                <div style="text-align: left; font-style: italic;">
                    <h2 style="color: #779ecb;">NO ACTIVE KAFKA CONNECT WORKER DETECTED</h2>
                </div>
            </html>
        </panel>
    </row>

    <!--

    BURROW

    -->

    <row>
        <panel>
            <html>
                <div class="dashseparator">
                    <div class="box">
                      <img src="../../static/app/telegraf-kafka/icons/kafka-logo-no-text.png"/>
                      <span style="font-size: 22px; font-weight: bold; color: #999999; margin-top: 5px;">KAFKA CONSUMERS MONITORING WITH BURROW</span>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row depends="$burrow_detected$">
        <panel>
            <single>
                <search base="burrow" depends="$burrow_detected$">
                    <query>stats count</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">all</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">KAFKA GROUP CONSUMERS MONITORED</option>
                <option name="useColors">1</option>
                <drilldown>
                  <link target="_self">/app/telegraf-kafka/telegraf-burrow?form.env=$form.env$&amp;form.label=$form.label$</link>
                </drilldown>
            </single>
        </panel>
        <panel>
            <single>
                <search base="burrow">
                    <query>| append [ | inputlookup kafka_burrow_consumers_monitoring | where monitoring_state="enabled" ]
| stats first(*) as "*" by env, label, cluster, group
| where monitoring_state="enabled"
| eventstats count(eval(range="severe")) as count_severe, count(eval(range="elevated")) as count_elevated
| stats first(count_severe) as count_severe, first(count_elevated) as count_elevated
| eval status=if(count_severe>count_elevated, 2, 1), status=if(count_severe=0 AND count_elevated=0, 0, status)
| rangemap field=status low=0-0 elevated=1-1 severe=2-2 default=severe
| eval status_human=case(range="low", "OK", range="elevated", "WARN", range="severe", "ERR")
| appendcols [ | makeresults | eval status_none="no consumers monitored yet", range_none="gray" ]
| eval status_human=if(isnull(status_human), "0 monitored consumers (update collection required)", status_human), range=if(isnull(range), range_none, range)
| fields status_human, range</query>
                </search>
                <option name="colorBy">value</option>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0</option>
                <option name="useColors">0</option>
                <option name="underLabel">AGGREGATED STATE</option>
                <option name="drilldown">all</option>
                <drilldown>
                  <link target="_self">/app/telegraf-kafka/telegraf-burrow?form.env=$form.env$&amp;form.label=$form.label$</link>
                </drilldown>
            </single>
        </panel>
    </row>

    <row depends="$burrow_detected$">
        <panel>
            <html>
                <div class="mainbutton_container_nomargin">
                    <div class="mainbutton_highmargin">
                        <a class="button2_lowpadding glow" href="telegraf-burrow?form.env=$form.env$&amp;form.label=$form.label$">  OPEN BURROW DASHBOARD VIEW  </a>
                    </div>
                </div>
            </html>
        </panel>
        <panel>
            <html>
                <div class="custom-sub-nav" style="text-align: center;">
                    <div class="mainbutton_highmargin">
                        <button class="button2_lowpadding glow" data-token-name="show_consumers_status" data-alt-label="HIDE CONSUMERS STATUS" data-token-value="fields *">SHOW CONSUMERS STATUS</button>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row depends="$show_consumers_status$">
        <panel>
            <table id="table_consumers">
            <title>Kafka Consumers Lag Burrow Monitoring</title>
                <search depends="$show_consumers_status$">
                    <query>| mstats latest(_value) as value where metric_name="burrow_group.lag" OR metric_name="burrow_group.status_code" `telegraf_kafka_index` group!="" $env$ $label$ by env, label, cluster, group, metric_name span=10s
| eval {metric_name}=value
| stats first(burrow_group.*) as "*" by _time, env, label, cluster, group
| stats max(_time) as lastTime, avg(lag) as avg_lag, max(lag) as max_lag, latest(lag) as current, sparkline(avg(lag),) As sparkline, latest(status_code) as status_code by env, label, cluster, group
| lookup burrow_status status_code OUTPUT status, description
| rangemap field=status_code low=1-1 elevated=2-2 default=severe
| eval avg_lag=round(avg_lag, 3), delta_lastTime=now()-lastTime, lastTime=strftime(lastTime, "%H:%M:%S")
| eval status=if(delta_lastTime>120, "UNKNOWN", status), description=if(delta_lastTime>120, "The delta in seconds between the last state received and now has exceeded 120 seconds", description)
| fields env, label, cluster, group, avg_lag, max_lag, current, sparkline, status, range, lastTime, description | rename description as "status description"
| lookup kafka_burrow_consumers_monitoring env, label, cluster, group OUTPUT monitoring_state</query>
                    <earliest>-60m</earliest>
                    <latest>now</latest>
                </search>
                <option name="drilldown">row</option>
                <drilldown>
                    <link>/app/telegraf-kafka/telegraf-burrow-detailed?env=$row.env$&amp;label=$row.label$&amp;cluster=$row.cluster$&amp;group=$row.group$</link>
                </drilldown>
            </table>
        </panel>
    </row>

    <row rejects="$burrow_detected$">
        <panel>
            <html>
                <div style="text-align: left; font-style: italic;">
                    <h2 style="color: #779ecb;">NO ACTIVE BURROW DETECTED</h2>
                </div>
            </html>
        </panel>
    </row>

    <!--

    CONFLUENT SCHEMA-REGISTRY

    -->

    <row>
        <panel>
            <html>
                <div class="dashseparator">
                    <div class="box">
                      <img src="../../static/app/telegraf-kafka/icons/confluent-logo.png"/>
                      <span style="font-size: 22px; font-weight: bold; color: #999999; margin-top: 5px;">SCHEMA-REGISTRY</span>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row depends="$schema_registry_detected$">
        <panel>
            <single>
                <search depends="$schema_registry_detected$">
                    <query>| savedsearch telegraf-kafka-schema-registry | search $env$ $label$ | stats count</query>
                    <earliest>-15m</earliest>
                    <latest>now</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">all</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">SCHEMA-REGISTRY NODES</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="schema_registry_summary">
                    <query>fields "jetty-metrics.connections-active"</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">ACTIVE CONNECTIONS REQ/SEC</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="schema_registry_summary">
                    <query>fields "jetty-metrics.connections-opened-rate"</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">OPENED CONNECTIONS REQ/SEC</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="schema_registry_summary">
                    <query>fields "jetty-metrics.connections-closed-rate"</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">CLOSED CONNECTIONS REQ/SEC</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="schema_registry_summary_jersey">
                    <query>fields "jersey-metrics.request-error-rate"</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">all</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">HTTP ERROR RESPONSES REQ/SEC</option>
                <option name="useColors">1</option>
            </single>
        </panel>
    </row>

    <row depends="$schema_registry_detected$">
        <panel>
            <html>
                <div class="mainbutton_container_nomargin">
                    <div class="mainbutton_highmargin">
                        <a class="button2_lowpadding glow" href="telegraf-kafka-confluent-shema-registry?form.env=$form.env$&amp;form.label=$form.label$">  OPEN ENTITY DASHBOARD VIEW  </a>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row rejects="$schema_registry_detected$">
        <panel>
            <html>
                <div style="text-align: left; font-style: italic;">
                    <h2 style="color: #779ecb;">NO ACTIVE SCHEMA-REGISTRY NODES DETECTED</h2>
                </div>
            </html>
        </panel>
    </row>

    <!--

    CONFLUENT KSQL-SERVER

    -->

    <row>
        <panel>
            <html>
                <div class="dashseparator">
                    <div class="box">
                      <img src="../../static/app/telegraf-kafka/icons/confluent-logo.png"/>
                      <span style="font-size: 22px; font-weight: bold; color: #999999; margin-top: 5px;">KSQL-SERVER</span>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row depends="$ksql_server_detected$">
        <panel>
            <single>
                <search depends="$ksql_server_detected$">
                    <query>| savedsearch telegraf-kafka-ksql-server | search $env$ $label$ | stats count</query>
                    <earliest>-15m</earliest>
                    <latest>now</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">all</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">KSQL-SERVER NODES</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="ksql_server_queries_activity_summary">
                    <query>fields num-active-queries</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">ACTIVE QUERIES</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="ksql_server_stats_activity_summary">
                    <query>fields "messages-consumed-per-sec"</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">REALTIME MESSAGES CONSUMED/SEC</option>
                <option name="unit">msg/sec</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="ksql_server_stats_activity_summary">
                    <query>fields "messages-produced-per-sec"</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">REALTIME MESSAGES PRODUCED/SEC</option>
                <option name="unit">msg/sec</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="ksql_server_stats_activity_summary">
                    <query>fields "error-rate"</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">ERROR RATE</option>
                <option name="useColors">1</option>
            </single>
        </panel>
    </row>

    <row depends="$ksql_server_detected$">
        <panel>
            <html>
                <div class="mainbutton_container_nomargin">
                    <div class="mainbutton_highmargin">
                        <a class="button2_lowpadding glow" href="telegraf-kafka-confluent-ksql-server?form.env=$form.env$&amp;form.label=$form.label$">  OPEN ENTITY DASHBOARD VIEW  </a>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row rejects="$ksql_server_detected$">
        <panel>
            <html>
                <div style="text-align: left; font-style: italic;">
                    <h2 style="color: #779ecb;">NO ACTIVE KSQL-SERVER NODES DETECTED</h2>
                </div>
            </html>
        </panel>
    </row>

    <!--

    CONFLUENT KAFKA-REST

    -->

    <row>
        <panel>
            <html>
                <div class="dashseparator">
                    <div class="box">
                      <img src="../../static/app/telegraf-kafka/icons/confluent-logo.png"/>
                      <span style="font-size: 22px; font-weight: bold; color: #999999; margin-top: 5px;">KAFKA-REST</span>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row depends="$kafka_rest_detected$">
        <panel>
            <single>
                <search depends="$kafka_rest_detected$">
                    <query>| savedsearch telegraf-kafka-kafka-rest | search $env$ $label$ | stats count</query>
                    <earliest>-15m</earliest>
                    <latest>now</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">all</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">KAFKA-REST NODES</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="kafka_rest_summary">
                    <query>fields "jetty-metrics.connections-active"</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">ACTIVE CONNECTIONS REQ/SEC</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="kafka_rest_summary">
                    <query>fields "jetty-metrics.connections-opened-rate"</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">OPENED CONNECTIONS REQ/SEC</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="kafka_rest_summary">
                    <query>fields "jetty-metrics.connections-closed-rate"</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x006d9c","0x006d9c"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">CLOSED CONNECTIONS REQ/SEC</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <single>
                <search base="kafka_rest_summary_jersey">
                    <query>fields "jersey-metrics.request-error-rate"</query>
                </search>
                <option name="colorMode">block</option>
                <option name="drilldown">all</option>
                <option name="numberPrecision">0.00</option>
                <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="underLabel">HTTP ERROR RESPONSES REQ/SEC</option>
                <option name="useColors">1</option>
            </single>
        </panel>
    </row>

    <row depends="$kafka_rest_detected$">
        <panel>
            <html>
                <div class="mainbutton_container_nomargin">
                    <div class="mainbutton_highmargin">
                        <a class="button2_lowpadding glow" href="telegraf-kafka-confluent-kafka-rest?form.env=$form.env$&amp;form.label=$form.label$">  OPEN ENTITY DASHBOARD VIEW  </a>
                    </div>
                </div>
            </html>
        </panel>
    </row>

    <row rejects="$kafka_rest_detected$">
        <panel>
            <html>
                <div style="text-align: left; font-style: italic;">
                    <h2 style="color: #779ecb;">NO ACTIVE KAFKA-REST NODES DETECTED</h2>
                </div>
            </html>
        </panel>
    </row>
    
</dashboard>